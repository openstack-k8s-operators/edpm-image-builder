ARG EDPM_BASE_IMAGE
FROM $EDPM_BASE_IMAGE

# edpm_bootstrap
ARG BOOTSTRAP_PACKAGES="\
    driverctl \
    lvm2 \
    crudini \
    jq \
    nftables \
    NetworkManager \
    openstack-selinux \
    python3-libselinux \
    python3-pyyaml \
    rsync \
    tmpwatch \
    sysstat \
    iproute-tc \
    ksmtuned \
    systemd-container \
    crypto-policies-scripts \
    grubby \
    openstack-network-scripts \
    "


ARG PACKAGES="\
    bind-utils \
    buildah \
    cephadm \
    chrony \
    cloud-init \
    device-mapper-multipath \
    growvols \
    iptables-services \
    iscsi-initiator-utils \
    numactl \
    openssh-server \
    openvswitch \
    os-net-config \
    podman \
    tuned-profiles-cpu-partitioning \
    yum-utils \
    "
ARG ENABLE_UNITS="openvswitch"

ARG LIBVIRT_PACKAGES="\
    libvirt \
    libvirt-admin \
    libvirt-client \
    libvirt-daemon \
    qemu-kvm \
    qemu-img \
    libseccomp \
    swtpm \
    swtpm-tools \
    edk2-ovmf \
    ceph-common \
    cyrus-sasl-scram \
    "

ARG TELEMETRY_LOGGING_PACKAGES="\
    rsyslog-openssl
    "

ARG RHSM_SCRIPT=empty.sh
COPY $RHSM_SCRIPT /var/tmp/rhsm-script.sh
RUN /var/tmp/rhsm-script.sh && \
    dnf -y install \
        $BOOTSTRAP_PACKAGES \
        $PACKAGES \
        $LIBVIRT_PACKAGES \
        $TELEMETRY_LOGGING_PACKAGES && \
    # edpm_bootstrap
    source /etc/os-release && if [ "${ID}" = "rhel" ]; then dnf -y install rhoso-release; fi && \
    dnf clean all && \
    (subscription-manager remove --all || true) && \
    (subscription-manager unregister || true) && \
    systemctl enable $ENABLE_UNITS

# Drop Ansible fact into place
COPY ansible-facts/bootc.fact /etc/ansible/facts.d/bootc.fact
RUN chmod +x /etc/ansible/facts.d/bootc.fact

# Disable automatic update check and reboot
RUN systemctl mask bootc-fetch-apply-updates.timer

# This should be the last command
# https://docs.fedoraproject.org/en-US/bootc/building-containers/#_linting
RUN bootc container lint
